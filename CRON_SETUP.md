# GitHub Issue 完全自動対応システム - cron設定

このスクリプトはcronで定期実行し、GitHub issueを**完全自動的に**検出・対応・PR作成まで行います。

⚠️ **警告**: このスクリプトは自動的にコード変更とプルリクエストを作成します。検証目的での使用を想定しています。

## 動作フロー

### 新規issue発見時
1. issueを検出
2. 「自動対応開始」コメントを投稿
3. 作業用ブランチ(`issue-N-auto-fix`)を作成
4. 自動でコード変更（現在はダミー実装）
5. コミット・プッシュ
6. プルリクエストを自動作成
7. issueにPR URLをコメント

### 既存issueに新規コメント時
1. コメントを検出
2. 既存の作業ブランチをチェックアウト
3. コメント内容に基づいて追加対応
4. コミット・プッシュ（PRを更新）
5. 「対応を追加しました」コメントを投稿

## セットアップ

### 1. 依存関係

```bash
# 必須ツール
- gh (GitHub CLI) - 認証済み
- jq
- git
- .copilot-profile ファイル
```

### 2. ログディレクトリの準備

```bash
mkdir -p logs
```

### 3. .gitignoreに追加

```
logs/
.last_issue_check
*.tmp
```

### 4. ブランチ保護設定

mainブランチへの直接pushを禁止しておくことを推奨します。

## cron設定

### テスト用（5分ごと）

```bash
crontab -e

# 以下を追加
*/5 * * * * cd /mnt/d/Works/repo/bingo-game && ./check-issues.sh >> logs/cron.log 2>&1
```

### 本番用（15分ごと）

```bash
*/15 * * * * cd /mnt/d/Works/repo/bingo-game && ./check-issues.sh >> logs/cron.log 2>&1
```

### 営業時間のみ（平日9-18時、毎時）

```bash
0 9-18 * * 1-5 cd /mnt/d/Works/repo/bingo-game && ./check-issues.sh >> logs/cron.log 2>&1
```

## 実装の詳細

### 自動化されている処理

✅ **Issue検出**
- 前回チェック以降の新規issueを取得
- Issue番号、タイトル、本文を抽出

✅ **ブランチ作成**
- `issue-N-auto-fix` 形式で自動命名
- mainから分岐
- 既存ブランチは削除して再作成

✅ **コード変更**
- 現在はダミー実装（`.issue-N.tmp`ファイルを作成）
- 将来的にはCopilot APIと統合予定

✅ **コミット**
- Issue内容を含むコミットメッセージ
- 「Generated by GitHub Copilot」署名を追加

✅ **プルリクエスト作成**
- タイトル: "Issue #Nの対応: [タイトル]"
- 本文: Issue内容と変更概要
- `Closes #N` で自動クローズ設定

✅ **コメント投稿**
- 自動対応開始通知
- PR作成通知
- コメントへの対応通知

### 現在の制限事項

❌ **実際のコード修正**
- 現在はダミーファイルを作成するのみ
- GitHub Copilot APIの非対話モードが必要

💡 **今後の拡張ポイント**
- GitHub Copilot Workspace APIとの統合
- AI による自動コード生成
- 自動テスト実行と検証
- テスト失敗時のリトライ

## 手動実行でのテスト

```bash
# 1回だけ実行してテスト
./check-issues.sh

# ログを確認
tail -f logs/issue-check-*.log

# 最新のログを表示
ls -t logs/issue-check-*.log | head -1 | xargs cat
```

## トラブルシューティング

### 認証エラー

```bash
# GitHub CLI認証状態を確認
gh auth status

# プロファイル確認
cat .copilot-profile

# 手動で切り替え
gh auth switch -u $(cat .copilot-profile)
```

### ブランチ作成エラー

```bash
# ローカルブランチを確認
git branch -a | grep issue-

# 不要なブランチを削除
git branch -D issue-*-auto-fix

# リモートブランチも削除
git push origin --delete issue-*-auto-fix
```

### PR作成エラー

```bash
# 権限を確認
gh auth status

# リポジトリ設定を確認
gh repo view threewoods-ak/bingo-game --json name,owner,permissions
```

### コミットが空になる

現在はダミーファイルを作成しますが、実際のコード変更がない場合は：
- `.issue-N.tmp` ファイルが作成されます
- これはテスト用なので `.gitignore` に追加推奨

## セキュリティとベストプラクティス

### 検証環境での使用

このスクリプトは検証目的のため、以下を推奨します：

1. **テスト用リポジトリで試す**
2. **ブランチ保護を有効化**（mainへの直接push禁止）
3. **PRは必ずレビューしてからマージ**
4. **定期的にログを確認**

### 本番環境での使用には

- コード変更の検証機能を追加
- テストの自動実行
- レビュー依頼の自動送信
- 失敗時のロールバック機能

## ログ管理

### ログファイル

- `logs/issue-check-YYYYMMDD-HHMMSS.log` - 実行ログ
- `logs/prompt-N.txt` - Copilotへのプロンプト
- `logs/cron.log` - cron実行ログ

### 自動クリーンアップ

30日以上前のログファイルは自動削除されます。

### ログの確認方法

```bash
# 最新のログ
tail -f logs/cron.log

# 特定のissueのログを検索
grep "Issue #5" logs/issue-check-*.log

# エラーログのみ
grep -i error logs/issue-check-*.log
```

## 完全自動化の実現

将来的に以下が実装されれば、真の完全自動化が可能です：

```bash
# 仮想的なコマンド例
gh copilot workspace apply \
  --issue $ISSUE_NUMBER \
  --auto-commit \
  --auto-test \
  --auto-pr \
  --require-tests-pass
```

現在は「自動ブランチ作成→ダミーコミット→PR作成」まで実装済みです。
