# ビンゴ数字ピックシステム

## 概要

計算式スロットで数字をピックする新感覚ビンゴゲーム。QRコード※でスマホから参加して、リーチ・ビンゴを自己申告できる。

※QRコードは株式会社デンソーウェーブの登録商標です。

## 起動方法

```bash
npm install
npm start
```

サーバーが起動したら、ブラウザで `http://localhost:3000` にアクセスしてください。

## 主な機能

- 🎰 計算式スロットによる数字ピック（1～75）
- 📱 QRコードでスマホから参加
- 🎵 効果音付きアニメーション
- 🎉 ビンゴ時のお祝いエフェクト
- 🎨 テーマ切り替え（パーティー/ダーク）
- 🔄 リアルタイム同期（WebSocket）

## 機能要件

### 1. 数字ピック機能

**基本ロジック**

* 計算式: `x [演算子] z = 結果`
* 結果は1～75の範囲内
* 一度出た数字は重複しない

**演算子別の制約**

- **加算(+)**: x=1～37, z=1～37 (最大74)
- **減算(-)**: x=1～75, z=1～74, かつ x > z (最小1)
- **乗算(×)**: x=1～8, z=1～9 (最大72)
- **除算(÷)**: x÷z の結果が1～75の整数になる組み合わせ

**重複回避**

* 既出数字の配列を保持
* 新規計算前にチェック
* 重複なら再計算（最大10回試行）
* 10回失敗したら残りの数字から直接選択
* 残り20個以下は自動的に直接選択モードに切り替え

**演算子の重み付け**

```javascript
const operators = ['+', '+', '-', '×', '÷'];
// 加算が2回、その他が1回ずつの確率
```

### 2. アニメーション・効果音

**スロット演出**

* 左の数字、演算子、右の数字が順番に確定していく演出
* 各要素は設定時間の間ランダムに変わり続けてから確定
* ランダム表示時間: ホスト画面から設定可能（100ms～2000ms、デフォルト500ms）
* 全体の流れ:
  1. 左の数字がランダム表示 → 確定
  2. 演算子がランダム表示 → 確定
  3. 右の数字がランダム表示 → 確定
  4. 結果表示

**アニメーション間隔の設定**

ホスト画面の「数字をピック」ボタンの下にある入力欄で、各要素のランダム表示時間（ミリ秒）を調整できます。
- 最小値: 100ms（高速）
- 最大値: 2000ms（ゆっくり）
- デフォルト: 500ms

**効果音（実装済み）**

| タイミング | 音声ファイル | 説明 |
|----------|------------|------|
| スロット回転中 | `empty-machine-gun-firing-clicks-341988.mp3` | ループ再生 |
| 結果確定時 | `cash-register-purchase-87313.mp3` | 1回再生 |
| リーチ申告時 | `notification-22-270130.mp3` | 1回再生 |
| ビンゴ申告時 | `loud-fanfare-trumpet-effect-02-412049.mp3` | 1回再生 |

**ビンゴ時のお祝いエフェクト**

* 画面中央に「🎉 BINGO! 🎉」ポップアップ表示
* プレイヤー名を表示
* カラフルな紙吹雪（50個）が降ってくるアニメーション
* 3秒後に自動クローズ（またはクリックで閉じる）

### 3. 履歴表示

**表示形式**

```
35  12  68  9  47  ...
```

* 数字のみ、横並び表示
* 最新が左端
* 大きめのフォント
* 残り個数も表示: 「残り: 58個」

### 4. プレイヤー管理機能

**参加フロー**

1. ホスト画面でQRコード表示
2. スマホでQR読み込み
3. ユーザー名入力（最大20文字）
4. 参加完了、メイン画面と同期開始

**プレイヤー画面（スマホ）**

```
┌──────────────┐
│ [ユーザー名]  │
├──────────────┤
│ 現在の数字: 35│
├──────────────┤
│ [リーチ!]     │
│ [ビンゴ!]     │
├──────────────┤
│ 履歴表示      │
└──────────────┘
```

**申告機能**

* リーチボタン: 押すと全員に通知（黄色バッジ表示）
* ビンゴボタン: 押すと全員に通知＋お祝いエフェクト（緑バッジ表示）
* 自己申告制（カード照合なし）
* ボタンを再度押すと取り消し可能

**メイン画面での表示**

```
参加者 (5人)
・田中太郎 [リーチ]
・山田花子
・佐藤次郎 [ビンゴ!]
・鈴木一郎 [リーチ]
・高橋美咲
```

### 5. テーマ切り替え

**パーティーモード（デフォルト）**

* ビビッドな配色
* 紫のグラデーション背景
* カラフルなボタン

**ダークモード**

* 暗めの背景（#1a1a2e）
* 目に優しい配色
* シンプルデザイン
## 技術仕様

### 1. 技術スタック

**実装済み構成**

* **Frontend**: Vanilla JavaScript + HTML5 + CSS3
* **Backend**: Node.js + Express
* **WebSocket**: Socket.io (リアルタイム同期)
* **QRコード生成**: qrcode パッケージ
* **音声**: HTML5 Audio API

**必須パッケージ**

```json
{
  "express": "^4.x",
  "socket.io": "^4.x",
  "qrcode": "^1.x"
}
```

### 2. データ構造

**ゲームセッション**

```javascript
{
  "sessionId": "default",
  "pickedNumbers": [35, 12, 68],
  "players": [
    {
      "id": "socket_id_123",
      "name": "田中太郎",
      "status": "reach",  // null | "reach" | "bingo"
      "joinedAt": "2025-11-12T15:00:00Z"
    }
  ],
  "startTime": "2025-11-12T15:00:00Z",
  "theme": "party"  // "party" | "dark"
}
```

### 3. リアルタイム同期（Socket.io イベント）

**クライアント → サーバー**

| イベント名 | パラメータ | 説明 |
|----------|----------|------|
| `join_session` | `{sessionId, isHost}` | セッションに参加 |
| `player_join` | `{sessionId, name}` | プレイヤーとして参加 |
| `pick_number` | なし | 数字をピック（ホストのみ） |
| `status_change` | `{status}` | リーチ/ビンゴ申告 |
| `theme_change` | `{theme}` | テーマ変更（ホストのみ） |
| `reset_game` | なし | ゲームリセット（ホストのみ） |

**サーバー → クライアント**

| イベント名 | データ | 説明 |
|----------|------|------|
| `session_state` | セッション情報 | 現在の状態を送信 |
| `player_registered` | `{playerId}` | プレイヤー登録完了 |
| `player_joined` | プレイヤー情報 | 新規プレイヤー参加通知 |
| `player_left` | `{playerId, name}` | プレイヤー離脱通知 |
| `number_picked` | `{calculation, pickedNumbers, remaining}` | 新しい数字がピックされた |
| `player_status_changed` | `{playerId, name, status}` | リーチ/ビンゴ申告通知 |
| `theme_changed` | `{theme}` | テーマ変更通知 |
| `game_reset` | なし | ゲームリセット通知 |
| `game_complete` | なし | 全数字出揃い通知 |

### 4. ファイル構成

```
bingo-game/
├── server.js                 # サーバー本体
├── package.json              # 依存関係
├── public/
│   ├── index.html           # ホスト画面
│   ├── player.html          # プレイヤー画面
│   └── sounds/              # 効果音ファイル
│       ├── empty-machine-gun-firing-clicks-341988.mp3
│       ├── cash-register-purchase-87313.mp3
│       ├── notification-22-270130.mp3
│       └── loud-fanfare-trumpet-effect-02-412049.mp3
└── README.md
```

### 5. UI/UX

**メイン画面（ホスト / PC・タブレット）**

```
┌─────────────────────────┐
│   🎉 ビンゴ数字ピック 🎉  │
├─────────────────────────┤
│   [QRコード表示]         │
├─────────────────────────┤
│  X  [演算子]  Z  = 結果  │
│   [数字をピック]         │
│ [ゲームリセット][テーマ切替]│
├─────────────────────────┤
│ 参加者 (5人)            │
│ ・田中太郎 [リーチ]      │
│ ・山田花子              │
│ ・佐藤次郎 [ビンゴ!]     │
├─────────────────────────┤
│ 履歴: 35 12 68 9 47...  │
│ 残り: 70個              │
└─────────────────────────┘
```

**プレイヤー画面（スマホ）**

```
┌─────────────┐
│ 🎮 ビンゴゲーム │
├─────────────┤
│  田中太郎     │
│              │
│ 現在の数字    │
│     35       │
│              │
│  [リーチ!]   │
│  [ビンゴ!]   │
├─────────────┤
│ 履歴         │
│ 35 12 68 9   │
└─────────────┘
```

**レスポンシブ対応**

* 320px～: スマホ縦
* 768px～: タブレット
* 1024px～: PC

### 6. パフォーマンス

* WebSocket接続: 即座に確立
* 状態同期遅延: 500ms以内
* 同時接続: 50人まで対応可能（理論値）
* 音声再生: ユーザー操作後に有効化（ブラウザポリシー準拠）

## エラーハンドリング

### 想定エラーと対策

| エラー | 対策 |
|-------|------|
| 接続切れ | 自動再接続、状態復元 |
| 同時ピック | サーバー側で排他制御（ホストのみ実行可能） |
| 重複計算失敗 | 残り数字から直接選択 |
| QR読めない | 手動URL入力も可能 |
| 音声再生失敗 | コンソールにエラーログ出力（ゲームは継続） |

### ユーザーへの通知

* **エラー時**: トースト通知（プレイヤー画面）
* **再接続中**: 「接続が切れました。再接続中...」メッセージ
* **成功時**: さりげないフィードバック（アニメーション、効果音）

## セキュリティ考慮

### 実装済み対策

* **セッションID**: デフォルトセッション使用（`default`）
* **プレイヤーID**: Socket.io の socket.id を使用（自動生成）
* **XSS対策**: HTMLエスケープ処理

### ユーザー名入力制限

* 最大20文字
* 特殊文字制限（実装推奨）
* 空白のみNG

## WSL2環境での起動

このプロジェクトはWSL2環境で動作します。

### Windowsからアクセスする方法

1. **localhost を使用（推奨）**
   ```
   http://localhost:3000
   ```

2. **WSL2のIPアドレスを使用**
   ```bash
   # WSL2のIPアドレスを確認
   hostname -I | awk '{print $1}'
   
   # 表示されたIPアドレスでアクセス
   http://172.x.x.x:3000
   ```

### スマホからアクセスする場合

スマホとPCが同じWi-Fiネットワークに接続されている必要があります。

1. WindowsのIPアドレスを確認
2. スマホのブラウザで `http://<WindowsのIP>:3000/player.html?session=default` にアクセス

## 技術的な実装ポイント

### 計算式の偏り対策

演算子の出現確率を調整することで、偏りを防止しています。

```javascript
const operators = ['+', '+', '-', '×', '÷'];
// 加算が2回、その他が1回ずつの確率
```

### 後半の数字生成

残り20個以下になると、計算で作るのが困難になるため、直接選択モードに切り替わります。

```javascript
if (remaining.length <= 20) {
  const num = remaining[Math.floor(Math.random() * remaining.length)];
  return { x: 0, operator: '+', z: num, result: num };
}
```

ただし、見た目上は計算式として表示されます。

## クレジット

### 商標について

QRコードは株式会社デンソーウェーブの登録商標です。

### 音声素材

本プロジェクトで使用している効果音は、[Pixabay](https://pixabay.com/) から提供されているフリー音源を使用しています。

| ファイル名 | 用途 |
|----------|------|
| `empty-machine-gun-firing-clicks-341988.mp3` | スロット回転音 |
| `cash-register-purchase-87313.mp3` | 結果確定音 |
| `notification-22-270130.mp3` | リーチ申告音 |
| `loud-fanfare-trumpet-effect-02-412049.mp3` | ビンゴ申告音 |

すべての音声素材は Pixabay License に基づき使用されています。

## ライセンス

MIT

## 作成日

2025-11-12

